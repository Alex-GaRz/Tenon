{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://tenon.internal/schemas/risk/v1/risk_signal.schema.json",
  "title": "RiskSignal",
  "description": "Unidad atómica de riesgo institucional - RFC-13 §5.1",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "risk_signal_id",
    "signal_type",
    "scope",
    "severity_level",
    "supporting_metrics",
    "supporting_evidence",
    "explanation",
    "observed_at",
    "signal_version"
  ],
  "properties": {
    "risk_signal_id": {
      "type": "string",
      "minLength": 1,
      "description": "Identificador único de la señal de riesgo"
    },
    "signal_type": {
      "type": "string",
      "enum": [
        "DISCREPANCY_CONCENTRATION_HIGH_BY_SOURCE",
        "DISCREPANCY_CONCENTRATION_HIGH_BY_TYPE",
        "DISCREPANCY_CONCENTRATION_HIGH_BY_FLOW",
        "DISCREPANCY_TEMPORAL_TREND_CRITICAL",
        "DISCREPANCY_AVERAGE_AGE_UNRESOLVED",
        "CORRELATION_CONFIDENCE_SCORE_DEGRADATION",
        "CORRELATION_AMBIGUOUS_INCREASE_BY_FLOW",
        "CORRELATION_ORPHAN_EVENT_GROWTH",
        "STATE_AMBIGUOUS_ACCUMULATION_OUTSIDE_SLA",
        "STATE_UNKNOWN_ACCUMULATION_OUTSIDE_SLA",
        "STATE_IN_TRANSIT_ACCUMULATION_OUTSIDE_SLA",
        "STATE_STALE_FLOWS_NO_EVOLUTION",
        "STATE_DIVERGENCE_EXPECTED_VS_OBSERVED",
        "IDEMPOTENCY_REJECT_DUPLICATE_INCREASE",
        "IDEMPOTENCY_FLAG_AMBIGUOUS_INCREASE",
        "IDEMPOTENCY_KEY_COLLISION_RECURRENT",
        "IDEMPOTENCY_GUARDIAN_BYPASS_OR_FAILURE",
        "CHANGE_IMPACT_ON_CORRELATION",
        "CHANGE_IMPACT_ON_STATES",
        "CHANGE_IMPACT_ON_DISCREPANCIES",
        "CHANGE_VERSION_COEXISTENCE_DIVERGENT_RESULTS",
        "CHANGE_DISCREPANCY_INCREASE_POST_CHANGE",
        "HUMAN_INTERVENTION_OVERUSE",
        "HUMAN_DISCREPANCY_REOPENING_RECURRENT",
        "HUMAN_OVERRIDE_DEPENDENCY"
      ],
      "description": "Tipo de señal - taxonomía cerrada derivada de RFC-13 §4"
    },
    "scope": {
      "type": "string",
      "enum": ["GLOBAL", "SOURCE", "FLOW", "COMPONENT"],
      "description": "Alcance de la señal de riesgo"
    },
    "severity_level": {
      "type": "string",
      "enum": ["LOW", "MEDIUM", "HIGH", "CRITICAL"],
      "description": "Nivel de severidad según umbrales institucionales"
    },
    "supporting_metrics": {
      "type": "array",
      "minItems": 1,
      "description": "Métricas derivadas que sustentan la señal (explicabilidad obligatoria)",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["metric_key", "metric_value", "metric_unit"],
        "properties": {
          "metric_key": {
            "type": "string",
            "minLength": 1,
            "description": "Clave de la métrica derivada"
          },
          "metric_value": {
            "type": "number",
            "description": "Valor observado de la métrica"
          },
          "metric_unit": {
            "type": "string",
            "minLength": 1,
            "description": "Unidad de medida (%, count, ratio, etc.)"
          }
        }
      }
    },
    "supporting_evidence": {
      "type": "array",
      "minItems": 1,
      "description": "Referencias a evidencia inmutable (WORM, event sourcing, etc.)",
      "items": {
        "type": "object",
        "additionalProperties": false,
        "required": ["evidence_type", "evidence_ref"],
        "properties": {
          "evidence_type": {
            "type": "string",
            "minLength": 1,
            "description": "Tipo de evidencia (WORM_ENTRY, EVENT_SOURCING, DISCREPANCY_RECORD, etc.)"
          },
          "evidence_ref": {
            "type": "string",
            "minLength": 1,
            "description": "Referencia única a la evidencia"
          }
        }
      }
    },
    "explanation": {
      "type": "string",
      "minLength": 1,
      "description": "Explicación human-readable del riesgo (invariante 3.3)"
    },
    "observed_at": {
      "type": "string",
      "format": "date-time",
      "description": "Timestamp de observación (inyectado, no reloj del sistema)"
    },
    "signal_version": {
      "type": "string",
      "minLength": 1,
      "description": "Versión del modelo/cálculo de señal (gobernanza)"
    }
  }
}
