name: ci-rfc
on:
  pull_request:
    paths:
      - "docs/rfcs/**"
      - ".github/workflows/ci-rfc.yml"

jobs:
  rfc_checks:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Ensure RFC index exists
        run: test -f docs/rfcs/README.md

      - name: Enforce RFC filename convention
        run: |
          set -e
          # Detecta archivos que NO sigan el patrón rfc-nn-nombre.md 
          # Exceptuando el Manifiesto y el README
          bad=$(find docs/rfcs -maxdepth 1 -type f -name "*.md" \
            ! -name "README.md" \
            ! -name "RFC-00_MANIFEST.md" \
            ! -regex ".*/rfc-[0-9][0-9][a-z]?-.*\.md" \
            -print)
          if [ -n "$bad" ]; then
            echo "Invalid RFC filename(s): $bad"
            exit 1
          fi

      - name: Require RFC template sections (minimum)
        run: |
          set -e
          # Busca en docs/rfcs/ y acepta archivos rfc-*.md o el Manifiesto
          for f in $(find docs/rfcs -maxdepth 1 -type f -name "*.md" ! -name "README.md"); do
            echo "Validating $f..."
            grep -q "^## Propósito" "$f" || (echo "Falta '## Propósito' en $f"; exit 1)
            grep -q "^## No-Goals" "$f" || (echo "Falta '## No-Goals' en $f"; exit 1)
            grep -q "^## Invariantes" "$f" || (echo "Falta '## Invariantes' en $f"; exit 1)
            grep -q "^## Threat Model" "$f" || (echo "Falta '## Threat Model' en $f"; exit 1)
            grep -q "^## Pruebas" "$f" || (echo "Falta '## Pruebas' en $f"; exit 1)
            grep -q "^## Criterios de Aceptación" "$f" || (echo "Falta '## Criterios de Aceptación' en $f"; exit 1)
          done